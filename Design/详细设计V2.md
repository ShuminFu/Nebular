
## 1. SignalR Handler (消息监听层)

  

### 1.1 MessageObserver（观察者模式）

  

#### 1.1.1 IMessageObserver 接口

```python

class IMessageObserver:

async def on_message(message: Message) -> None

async def on_error(error: Exception) -> None

```

  

#### 1.1.2 SignalRMessageSubject

- 管理观察者列表

- 分发消息事件

- 错误处理

  

## 2. Core Layer (核心层)

  

### 2.1 基础接口 (interfaces.py)

  

#### 2.1.1 IAgent 接口

```python

class IAgent:

async def send_message(message: str) -> None

async def get_response() -> str

@property def capabilities() -> Dict[str, Any]

async def invoke_capability(capability_name: str, **kwargs) -> Any

```

  

#### 2.1.2 IAgentAdapter 接口

```python

class IAgentAdapter:

async def adapt(config: Dict[str, Any]) -> IAgent

```

  

### 2.2 会话管理 (conversation.py)

  

#### 2.2.1 Message 数据类

```python

@dataclass

class Message:

content: str

sender: str

receiver: Optional[str]

metadata: Dict

```

  

#### 2.2.2 ConversationManager

- *创建和管理会话*

- 消息路由和广播

- 消息格式适配

- 能力兼容性检查

  

## 3. Adapters Layer (适配器层)

  

### 3.1 Autogen适配器

  

#### 3.1.1 AutogenAgentAdapter

- 适配Autogen的Agent创建

- 配置转换

  

#### 3.1.2 AutogenAgentWrapper

- 实现IAgent接口

- 包装Autogen原生功能

- 能力声明和调用

  

### 3.2 Aider适配器

  

#### 3.2.1 AiderAgentAdapter

- 适配Aider的编程助手

- 配置管理

  

#### 3.2.2 AiderAgentWrapper

- 实现IAgent接口

- 代码处理能力

- 特殊功能适配

  

### 3.3 CrewAI适配器

  

#### 3.3.1 CrewAIAgentAdapter

- 适配CrewAI的Agent

- 团队协作配置

  

#### 3.3.2 CrewAIAgentWrapper

- 实现IAgent接口

- 团队协作能力

- 任务分配适配

  

## 4. Opera Integration (集成层)

  

### 4.1 OperaService

```python

class OperaService:

async def sync_conversation(conv_id: str, state: Dict) -> None

async def notify_message(message: Message) -> None

async def handle_opera_event(event: Dict) -> None

```

  

### 4.2 配置管理

```python

class Config:

# 框架配置

FRAMEWORK_CONFIGS = {

'autogen': {...},

'aider': {...},

'crewai': {...}

}

# Opera集成配置

OPERA_CONFIG = {...}

```

  

## 5. 系统架构

  

### 5.1 目录结构

```

bot_manager/

├── core/

│ ├── interfaces.py # 核心接口定义

│ └── conversation.py # 会话管理

├── adapters/

│ ├── autogen_adapter.py

│ ├── aider_adapter.py

│ └── crewai_adapter.py

├── integration/

│ └── opera.py # Opera集成

└── config.py # 配置文件

```

  

### 5.2 消息流转

```

User Request -> SignalR Handler -> ConversationManager -> Agent

-> Opera Integration

```

  

## 6. 关键实现细节

  

### 6.1 消息适配机制

```python

async def _adapt_message(message: str, from_agent: IAgent, to_agent: IAgent) -> str:

# 能力兼容性检查

if not self._check_capability_compatibility(from_agent, to_agent):

raise IncompatibleAgentsError()

# 根据目标Agent能力调整格式

if "code_generation" in to_agent.capabilities:

return self._format_code_message(message)

return message

```

  

### 6.2 会话管理

```python

class ConversationManager:

async def create_conversation(agents_config: List[Dict]) -> str:

# 创建会话

conv_id = self._generate_conv_id()

agents = {}

for config in agents_config:

adapter = self._get_adapter(config["framework"])

agent = await adapter.adapt(config)

agents[agent.name] = agent

return conv_id

```

  

## 7. 扩展性考虑

  

### 7.1 新增框架支持

1. 实现对应的IAgentAdapter

2. 实现IAgent包装器

3. 注册框架配置

  

### 7.2 新增能力支持

1. 在capabilities中声明新能力

2. 实现能力适配逻辑

3. 更新消息转换机制

  

## 8. 错误处理

  

### 8.1 异常定义

```python

class BotManagerError(Exception): pass

class IncompatibleAgentsError(BotManagerError): pass

class AgentNotFoundError(BotManagerError): pass

class ConversationNotFoundError(BotManagerError): pass

```

  

### 8.2 错误恢复策略

1. 会话状态保存

2. 消息重试机制

3. 降级处理

  

## 9. 监控指标

  

### 9.1 性能指标

- Agent响应时间

- 消息处理延迟

- 资源使用情况

  

### 9.2 业务指标

- 会话完成率

- 能力调用成功率

- 错误发生频率


# 重构方向
## 1. 系统定位调整

### 1.1 核心职责

- Bot模板管理和实例化

- Bot能力抽象和适配

- Opera交互协议实现

- Bot状态同步

### 1.2 与Opera的关系

- BotManager作为Bot提供方

- Opera负责Bot间通信和场景管理

- BotManager需要实现Opera定义的Staff接口

## 2. 核心概念重构

### 2.1 Bot Template（机器人模板）

- 定义Bot的基础能力和属性

- 包含默认配置

- 支持多框架适配（Autogen/Aider/CrewAI）

- 提供能力声明机制

### 2.2 Staff Instance（职员实例）

- Bot模板的具体实例化

- 实现Opera Staff接口

- 维护与Opera的连接状态

- 处理Opera的事件和命令

### 2.3 Capability Registry（能力注册表）

- 统一管理Bot能力

- 提供能力检索和匹配

- 支持能力版本控制

- 处理能力冲突

## 3. 系统架构重构